<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cazal Web Interpreter</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ctp-mocha-base: #24273a;
            --ctp-mocha-mantle: #1e2030;
            --ctp-mocha-crust: #181926;
            --ctp-mocha-text: #cad3f5;
            --ctp-mocha-subtext0: #a5adcb;
            --ctp-mocha-subtext1: #b8c0e0;
            --ctp-mocha-surface0: #363a4f;
            --ctp-mocha-surface1: #494d64;
            --ctp-mocha-surface2: #5b6078;
            --ctp-mocha-blue: #8aadf4;
            --ctp-mocha-sky: #91d7e3;
            --ctp-mocha-teal: #8bd5ca;
            --ctp-mocha-green: #a6da95;
            --ctp-mocha-yellow: #eed49f;
            --ctp-mocha-peach: #f5a97f;
            --ctp-mocha-maroon: #ee99a0;
            --ctp-mocha-red: #ed8796;
            --ctp-mocha-mauve: #c6a0f6;
            --ctp-mocha-pink: #f5bde6;
            --ctp-mocha-flamingo: #f0c6c6;
            --ctp-mocha-rosewater: #f4dbd6;

            --bg-color: var(--ctp-mocha-base);
            --panel-bg: var(--ctp-mocha-mantle);
            --text-color: var(--ctp-mocha-text);
            --accent-color: var(--ctp-mocha-blue);
            --highlight-color: var(--ctp-mocha-mauve);
            --token-color: var(--ctp-mocha-sky);
            --stack-color: var(--ctp-mocha-green);
            --stack-item-bg: var(--ctp-mocha-surface1);
            --button-bg: var(--ctp-mocha-blue);
            --button-hover: var(--ctp-mocha-mauve);
            --error-bg: var(--ctp-mocha-red);
            --executing-token: var(--ctp-mocha-peach);
            --accent-text: var(--ctp-mocha-crust);
        }

        html,
        body {
            height: 100%;
        }

        * {
            font-family: 'Space Mono', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            height: 100vh;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--ctp-mocha-crust) 0%, var(--ctp-mocha-mantle) 100%);
            z-index: -1;
        }

        .container {
            max-width: 100vw;
            width: 100vw;
            margin: 0;
            display: flex;
            flex-direction: row;
            height: 100vh;
            min-height: 100vh;
            box-sizing: border-box;
            padding: 0 0 0 0;
        }

        .main-content,
        .sidebar {
            flex: 1 1 0;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .main-content {
            padding: 24px;
        }

        .sidebar {
            padding: 24px 24px 24px 0;
        }

        h1,
        h2,
        h3 {
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 12px;
        }

        .logo {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--highlight-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: 4px;
            padding: 20px 20px 16px 20px;
            margin-bottom: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
            border: 1.5px solid var(--ctp-mocha-surface1);
            width: 100%;
            box-sizing: border-box;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: 'Space Mono', monospace;
            padding: 14px;
            background-color: rgba(0, 41, 58, 0.8);
            color: var(--text-color);
            border: 1.5px solid var(--ctp-mocha-surface1);
            border-radius: 4px;
            resize: vertical;
            font-size: 1.1em;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        .output {
            background-color: rgba(0, 41, 58, 0.5);
            padding: 14px;
            height: min-content;
            margin-top: 10px;
            border-radius: 4px;
            border: 1.5px solid var(--ctp-mocha-surface1);
            border-left: 4px solid var(--ctp-mocha-surface1);
            overflow-x: auto;
        }

        .error {
            background-color: var(--error-bg);
            color: var(--text-color);
            padding: 14px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1.5px solid var(--ctp-mocha-surface1);
            border-left: 4px solid var(--ctp-mocha-surface1);
            font-weight: bold;
        }

        button {
            background-color: var(--button-bg);
            color: var(--accent-text);
            border: 1.5px solid var(--ctp-mocha-surface1);
            padding: 10px 20px;
            margin: 10px 8px 10px 0;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 1em;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        button:hover {
            background-color: var(--button-hover);
            color: var(--accent-text);
            border-color: var(--ctp-mocha-surface1);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 0;
        }

        .stack-container {
            margin-top: 10px;
        }

        .stack-item {
            display: inline-block;
            padding: 6px 12px;
            margin: 3px 4px;
            background-color: var(--stack-item-bg);
            color: var(--stack-color);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.18);
            font-size: 1.08em;
            border: 1px solid var(--ctp-mocha-surface1);
        }

        #tokens {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .token {
            padding: 8px;
            border-radius: 4px;
            background-color: var(--token-color);
            line-height: 1.1;
            color: var(--accent-text);
            transition: background 0.2s, color 0.2s;
        }

        .token.executing {
            background-color: var(--executing-token);
            font-weight: bold;
            box-shadow: 0 0 8px var(--highlight-color);
            color: var(--accent-text);
        }

        .docs {
            flex: 1 1 auto;
            height: 100%;
            overflow-y: auto;
            padding-right: 0;
            background: var(--panel-bg);
            border-radius: 4px;
            border: 1.5px solid var(--ctp-mocha-surface1);
            box-sizing: border-box;
        }

        .docs table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            border-radius: 4px;
            overflow: hidden;
            border: 1.5px solid var(--ctp-mocha-surface1);
        }

        .docs th,
        .docs td {
            border: 1.5px solid var(--ctp-mocha-surface1);
            padding: 10px 12px;
            text-align: left;
            border-radius: 0;
        }

        .docs th {
            background-color: var(--accent-color);
            color: var(--accent-text);
            font-weight: bold;
            border-radius: 0;
        }

        .docs code {
            background-color: var(--ctp-mocha-surface0);
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 1em;
        }

        .tabs {
            display: flex;
            margin-bottom: -1px;
            width: 100%;
        }

        .tab {
            padding: 12px 24px;
            background-color: var(--panel-bg);
            border-radius: 4px;
            cursor: pointer;
            border: 1.5px solid var(--ctp-mocha-surface1);
            margin-right: 6px;
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.08em;
            transition: background 0.2s, color 0.2s;
        }

        .tab.active {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border-bottom: 1.5px solid var(--panel-bg);
        }

        .tab-content {
            display: none;
            padding-top: 12px;
            border-radius: 0 0 4px 4px;
            border-top: none;
            width: 100%;
            box-sizing: border-box;
        }

        .tab-content.active {
            display: block;
            width: 100%;
        }

        @media (max-width: 1100px) {
            .container {
                flex-direction: column;
                gap: 0;
                padding: 0;
            }

            .main-content,
            .sidebar {
                max-width: 100vw;
                padding: 16px;
            }

            .sidebar {
                max-width: 100vw;
                min-width: 0;
                padding: 16px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                gap: 0;
                padding: 0;
            }

            .main-content,
            .sidebar {
                max-width: 100vw;
                padding: 8px;
            }

            .sidebar {
                max-width: 100vw;
                min-width: 0;
                padding: 8px;
            }

            .docs {
                height: 400px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-content">
            <h1 class="logo">Cazal Web Interpreter</h1>

            <div class="panel">
                <h3>Code Editor</h3>
                <textarea id="code"
                    placeholder="Enter Cazal code here...">12 duplicate 1 - ( duplicate 1 - ) repeat ( * ) fold</textarea>

                <div class="controls">
                    <button id="run">Run All</button>
                    <button id="step-back">Step Back</button>
                    <button id="step-next">Step Next</button>
                    <button id="reset">Reset</button>
                </div>

                <div id="error" class="error" style="display: none;"></div>
            </div>

            <div class="panel">
                <h3>Tokens:</h3>
                <div id="tokens" class="output"></div>
            </div>

            <div class="panel">
                <h3>Stack:</h3>
                <div id="stack" class="output">[ ]</div>
            </div>
        </div>

        <div class="sidebar">
            <div class="panel docs">
                <div class="tabs">
                    <div class="tab active" data-tab="basic">Basics</div>
                    <div class="tab" data-tab="operators">Operators</div>
                    <div class="tab" data-tab="functions">Functions</div>
                    <div class="tab" data-tab="examples">Examples</div>
                </div>

                <div class="tab-content active" id="basic-tab">
                    <h2>Cazal Stack-Based Programming Language</h2>
                    <p>Cazal is a stack-based programming language where operations are performed on values stored in a
                        stack. Programs are evaluated from left to right, pushing values onto the stack and executing
                        operations.</p>

                    <h3>Core Concepts</h3>
                    <h4>Stack</h4>
                    <p>The stack is the central data structure in Cazal. Operations:</p>
                    <ul>
                        <li>Push values onto the stack</li>
                        <li>Pop values off the stack</li>
                        <li>Manipulate values on the stack</li>
                    </ul>

                    <h4>Functions</h4>
                    <p>Functions in Cazal are defined using parentheses <code>( )</code>. When a function is encountered
                        during parsing, it's treated as a single unit that can be pushed onto the stack and executed
                        later.</p>

                    <h3>Data Types</h3>
                    <p>Cazal supports the following data types:</p>
                    <ul>
                        <li><strong>Int</strong> - Integer values</li>
                        <li><strong>Float</strong> - Floating-point values</li>
                        <li><strong>DefinedFn</strong> - User-defined functions enclosed in parentheses</li>
                    </ul>
                </div>

                <div class="tab-content" id="operators-tab">
                    <h3>Operators</h3>
                    <p>Operators are in postfix notation. For example, <code>a b +</code> means "push <code>a</code>,
                        push <code>b</code>, add them together".</p>

                    <h4>Arithmetic Operators</h4>
                    <table>
                        <tr>
                            <th>Operator</th>
                            <th>Description</th>
                        </tr>
                        <tr>
                            <td><code>+</code></td>
                            <td>Addition</td>
                        </tr>
                        <tr>
                            <td><code>-</code></td>
                            <td>Subtraction</td>
                        </tr>
                        <tr>
                            <td><code>*</code></td>
                            <td>Multiplication</td>
                        </tr>
                        <tr>
                            <td><code>/</code></td>
                            <td>Division</td>
                        </tr>
                        <tr>
                            <td><code>%</code></td>
                            <td>Modulo (integers only)</td>
                        </tr>
                    </table>

                    <h4>Bitwise Operators</h4>
                    <table>
                        <tr>
                            <th>Operator</th>
                            <th>Description</th>
                        </tr>
                        <tr>
                            <td><code>&</code></td>
                            <td>Bitwise AND</td>
                        </tr>
                        <tr>
                            <td><code>|</code></td>
                            <td>Bitwise OR</td>
                        </tr>
                        <tr>
                            <td><code>^</code></td>
                            <td>Bitwise XOR</td>
                        </tr>
                        <tr>
                            <td><code>~</code></td>
                            <td>Bitwise NOT (unary)</td>
                        </tr>
                    </table>
                </div>

                <div class="tab-content" id="functions-tab">
                    <h3>Functions</h3>

                    <h4>Stack Manipulation</h4>
                    <table>
                        <tr>
                            <th>Function</th>
                            <th>Description</th>
                            <th>Effect</th>
                        </tr>
                        <tr>
                            <td><code>duplicate</code></td>
                            <td>Duplicates the top value</td>
                            <td>[a] → [a a]</td>
                        </tr>
                        <tr>
                            <td><code>pop</code></td>
                            <td>Removes and prints the top value</td>
                            <td>[a] → []</td>
                        </tr>
                        <tr>
                            <td><code>reverse</code></td>
                            <td>Reverses the entire stack</td>
                            <td>[a b c] → [c b a]</td>
                        </tr>
                        <tr>
                            <td>[n] <code>swap</code></td>
                            <td>swaps elements on the stack, takes top value as which item(starting from the top, so
                                <code>1 swap</code> swaps the top 2 items, excluding the 1) to swap with</td>
                            <td>[a b c d e] 2 swap → [a b e d c]</td>
                        </tr>
                    </table>

                    <h4>Higher-Order Functions</h4>
                    <table>
                        <tr>
                            <th>Function</th>
                            <th>Description</th>
                        </tr>
                        <tr>
                            <td>[fn] <code>map</code></td>
                            <td>Applies a function to each element on the stack</td>
                        </tr>
                        <tr>
                            <td>[fn] <code>fold</code></td>
                            <td>Combines stack elements using a function</td>
                        </tr>
                        <tr>
                            <td>[count, fn] <code>repeat</code></td>
                            <td>Repeats a function n times, where n is the second-to-top value on the stack</td>
                        </tr>
                        <tr>
                            <td>[fn] <code>exec</code></td>
                            <td>Executes a function once (1 repeat)</td>
                        </tr>
                    </table>

                    <h4>Type Conversion</h4>
                    <table>
                        <tr>
                            <th>Function</th>
                            <th>Description</th>
                        </tr>
                        <tr>
                            <td><code>floor</code></td>
                            <td>Converts a float to int by rounding down</td>
                        </tr>
                        <tr>
                            <td><code>ceil</code></td>
                            <td>Converts a float to int by rounding up</td>
                        </tr>
                    </table>
                </div>

                <div class="tab-content" id="examples-tab">
                    <h3>Examples</h3>

                    <h4>Basic Arithmetic</h4>
                    <pre><code>2 3 +</code></pre>
                    <p>Pushes 2 and 3 onto the stack, then adds them, resulting in 5.</p>

                    <h4>Factorial Calculation</h4>
                    <pre><code>0 1 2 3 4 5 6 7 8 9 ( 1 + ) map ( * ) fold</code></pre>
                    <p>This calculates 10!:</p>
                    <ol>
                        <li>Push numbers 0-9 onto the stack</li>
                        <li>Map the function <code>( 1 + )</code> to each element, resulting in 1-10</li>
                        <li>Fold using multiplication, calculating the product: 10!</li>
                    </ol>

                    <h4>Using Repeat</h4>
                    <pre><code>1 ( 2 * ) 5 repeat</code></pre>
                    <p>This pushes 1, 5 onto the stack, then repeats the function <code>( 2 * )</code> which doubles the
                        value on the stack. The result is 5 * 2^5 = 160.</p>

                    <h4>Using Map and Custom Functions</h4>
                    <pre><code>1 2 3 4 ( 2 + 3 * ) map</code></pre>
                    <p>This pushes 1, 2, 3, 4 onto the stack, then applies the function <code>( 2 + 3 * )</code> to each
                        element. For each value <code>n</code>, it computes <code>(n+2)*3</code>.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Program state
        let executionHistory = [];
        let currentStep = -1;
        let totalSteps = 0;
        let hasErrors = false;
        let tokensArray = [];

        // DOM elements
        const codeElement = document.getElementById('code');
        const tokensElement = document.getElementById('tokens');
        const stackElement = document.getElementById('stack');
        const errorElement = document.getElementById('error');

        // Tab handling
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });

        // Automatically parse when code changes
        let parseTimeout;
        codeElement.addEventListener('input', () => {
            clearTimeout(parseTimeout);
            parseTimeout = setTimeout(parseCode, 300); // Debounce input
        });

        // Load the WASM module
        var Module = {
            onRuntimeInitialized: function () {
                console.log('WASM module loaded');
                // Initialize the environment
                Module.ccall('init_environment', 'void', [], []);

                // Set up event listeners
                document.getElementById('run').addEventListener('click', runCode);
                document.getElementById('step-next').addEventListener('click', stepForward);
                document.getElementById('step-back').addEventListener('click', stepBackward);
                document.getElementById('reset').addEventListener('click', resetExecution);

                // Parse initial code
                parseCode();
            },
            // Capture stderr for error handling
            printErr: function (text) {
                showError(text);
                console.error(text);
                hasErrors = true;
            }
        };

        function showError(message) {
            errorElement.textContent = "Error: " + message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            errorElement.style.display = 'none';
            hasErrors = false;
        }

        function parseCode() {
            hideError();
            const code = codeElement.value;

            // Clear the WASM stack state before parsing new code
            if (typeof Module !== 'undefined' && Module.ccall) {
                try {
                    Module.ccall('reset_stack', 'void', [], []);
                } catch (e) {
                    // If reset_stack is not implemented, ignore
                }
            }

            try {
                const tokenCount = Module.ccall('lex_code', 'number', ['string'], [code]);
                if (tokenCount >= 0) {
                    const tokensStr = Module.ccall('get_tokens_string', 'string', [], []);
                    tokensArray = parseTokensString(tokensStr);
                    displayTokens(tokensArray);
                    totalSteps = tokenCount;
                    resetExecution();
                } else {
                    tokensElement.textContent = 'Error parsing code';
                }
            } catch (e) {
                showError(e.toString());
            }
        }

        function parseTokensString(tokensStr) {
            // Simple parser for the tokens string
            const lines = tokensStr.split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {
                const match = line.match(/(\d+): (.) -> (.*)/);
                if (match) {
                    return {
                        index: parseInt(match[1]),
                        type: match[2],
                        value: match[3]
                    };
                }
                return null;
            }).filter(token => token !== null);
        }

        function displayTokens(tokens, currentExecutingIndex = -1) {
            tokensElement.innerHTML = tokens.map(token => {
                const isExecuting = token.index === currentExecutingIndex;
                return `<span class="token ${isExecuting ? 'executing' : ''}" data-index="${token.index}">
                    ${token.value}
                </span>`;
            }).join(' ');
        }

        function resetExecution() {
            executionHistory = [{
                stackState: "[ ]",
                stepIndex: -1
            }];
            currentStep = 0;

            // Clear the WASM stack state
            if (typeof Module !== 'undefined' && Module.ccall) {
                try {
                    Module.ccall('reset_stack', 'void', [], []);
                } catch (e) {
                    // If reset_stack is not implemented, ignore
                }
            }

            updateStackDisplay();
            displayTokens(tokensArray);
        }

        function runCode() {
            parseCode();
            if (hasErrors) return;

            try {
                const stackSize = Module.ccall('execute_all', 'number', [], []);
                if (stackSize >= 0) {
                    const stackStr = Module.ccall('get_stack_string', 'string', [], []);
                    // Format the stack with brackets
                    const formattedStack = formatStack(stackStr);
                    stackElement.innerHTML = formattedStack;

                    // Save entire execution as single step for history
                    executionHistory = [{
                        stackState: "[ ]",
                        stepIndex: -1
                    }, {
                        stackState: formattedStack,
                        stepIndex: totalSteps
                    }];
                    currentStep = 1;

                    // Mark all tokens as executed
                    displayTokens(tokensArray, totalSteps - 1);
                } else {
                    showError('Error executing code');
                }
            } catch (e) {
                showError(e.toString());
            }
        }

        function formatStack(stackStr) {
            if (!stackStr || stackStr.trim() === '') return "[ ]";

            // Process the raw stack string
            const items = stackStr.trim().split('|').map(item => item.trim()).filter(item => item !== '');

            if (items.length === 0) return "[ ]";

            // Create HTML with styled items
            return "[ " + items.map(item =>
                `<span class="stack-item">${item}</span>`
            ).join(' ') + " ]";
        }

        function stepForward() {
            if (hasErrors) return;

            // If we're at the beginning, parse the code first
            if (currentStep === 0 && executionHistory.length === 1) {
                parseCode();
                if (hasErrors) return;
            }

            // If we're at the end of our history but not at the end of execution
            if (currentStep === executionHistory.length - 1 && executionHistory[currentStep].stepIndex < totalSteps - 1) {
                try {
                    const nextStepIndex = executionHistory[currentStep].stepIndex + 1;
                    const result = Module.ccall('execute_step', 'number', ['number'], [nextStepIndex]);

                    if (result >= 0) {
                        const stackStr = Module.ccall('get_stack_string', 'string', [], []);
                        const formattedStack = formatStack(stackStr);

                        executionHistory.push({
                            stackState: formattedStack,
                            stepIndex: nextStepIndex
                        });
                        currentStep++;
                        updateStackDisplay();

                        // Highlight the current executing token
                        displayTokens(tokensArray, nextStepIndex);
                    } else {
                        showError('Error executing step');
                    }
                } catch (e) {
                    showError(e.toString());
                }
            }
            // If we're in the middle of our history
            else if (currentStep < executionHistory.length - 1) {
                currentStep++;
                updateStackDisplay();
                displayTokens(tokensArray, executionHistory[currentStep].stepIndex);
            }
        }

        function stepBackward() {
            if (currentStep > 0) {
                currentStep--;
                updateStackDisplay();
                displayTokens(tokensArray, executionHistory[currentStep].stepIndex);
            }
        }

        function updateStackDisplay() {
            if (executionHistory.length > 0 && currentStep >= 0 && currentStep < executionHistory.length) {
                stackElement.innerHTML = executionHistory[currentStep].stackState;
            } else {
                stackElement.innerHTML = "[ ]";
            }
        }
    </script>
    <script async src="cazal.js"></script>
</body>

</html>